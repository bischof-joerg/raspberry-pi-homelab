api:
  enabled: true
  address: 127.0.0.1:8686

sources:
  docker:
    type: docker_logs
    docker_host: unix:///var/run/docker.sock

transforms:
  normalize:
    type: remap
    inputs: ["docker"]
    source: |
      # Timestamp (best effort)
      if exists(.timestamp) && is_string(.timestamp) {
        .timestamp = parse_timestamp!(.timestamp, "%+")
      }

      # Message (docker_logs: usually .message, sometimes .log)
      if exists(.message) {
        .message = to_string!(.message)
      } else if exists(.log) {
        .message = to_string!(.log)
      } else {
        .message = ""
      }

      # Host (stream field)
      .host = get_env_var!("HOSTNAME")

      # container_name (stream field) - stepwise fallbacks (VRL 0.51.1 safe)
      .container_name = to_string(.container_name) ?? ""
      if .container_name == "" { .container_name = to_string(.container) ?? "" }
      if .container_name == "" { .container_name = to_string(.docker.container_name) ?? "" }
      if .container_name == "" { .container_name = to_string(.docker.container.name) ?? "" }
      if .container_name == "" { .container_name = "unknown" }

      # Compose metadata:
      # docker_logs flattens labels to top-level keys like:
      #   label.com.docker.compose.project
      #   label.com.docker.compose.service
      .stack = to_string(."label.com.docker.compose.project") ?? "homelab-home-prod-mon"
      .service = to_string(."label.com.docker.compose.service") ?? .container_name

      # namespace = fixed env marker (stream field)
      .namespace = to_string(.namespace) ?? "prod"

      # Level normalization (best-effort, VRL 0.51-friendly without else-if chain)
      .level = downcase(to_string(.level) ?? "")
      if .level == "" {
        msg = downcase(.message)

        if contains(msg, " error") || starts_with(msg, "error") {
          .level = "error"
        } else {
          if contains(msg, " warn") || starts_with(msg, "warn") {
            .level = "warn"
          } else {
            if contains(msg, " debug") || starts_with(msg, "debug") {
              .level = "debug"
            } else {
              .level = "info"
            }
          }
        }
      }

sinks:
  vlogs:
    type: http
    inputs: ["normalize"]
    uri: "http://victorialogs:9428/insert/jsonline?_stream_fields=host,stack,service,namespace,container_name&_msg_field=message&_time_field=timestamp"
    compression: gzip
    encoding:
      codec: json
    framing:
      method: newline_delimited
    healthcheck:
      enabled: false
    # Backpressure guardrail: bounded in-memory buffering (Pi-safe)
    buffer:
      max_events: 20000
      when_full: drop_newest
