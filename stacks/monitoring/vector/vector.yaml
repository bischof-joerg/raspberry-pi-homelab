api:
  enabled: true
  address: 127.0.0.1:8686
  playground: false

sources:
  docker:
    type: docker_logs
    docker_host: unix:///var/run/docker.sock

transforms:
  normalize:
    type: remap
    inputs: ["docker"]
    source: |
      # Message
      .message = ""
      if exists(.message) { .message = to_string!(.message) }
      else if exists(.log) { .message = to_string!(.log) }

      # Timestamp (best-effort)
      .timestamp = now()
      if exists(.timestamp) {
        .timestamp = parse_timestamp(.timestamp, "%+") ?? now()
      }

      # Stable host name:
      # Prefer HOST_NODE_NAME (set via compose), fall back to HOSTNAME, else constant.
      .host = get_env_var("HOST_NODE_NAME") ?? get_env_var("HOSTNAME") ?? "unknown-pi"

      # container_name (best-effort)
      .container_name = to_string(.container_name) ?? ""
      if .container_name == "" { .container_name = to_string(.container) ?? "" }
      if .container_name == "" { .container_name = to_string(.docker.container_name) ?? "" }
      if .container_name == "" { .container_name = to_string(.docker.container.name) ?? "" }
      if .container_name == "" { .container_name = "unknown" }

      # stack/service: try common label locations, stepwise (VRL 0.51 safe)
      .stack = to_string(.label."com.docker.compose.project") ?? ""
      if .stack == "" { .stack = to_string(.labels."com.docker.compose.project") ?? "" }
      if .stack == "" { .stack = to_string(.docker.container.labels."com.docker.compose.project") ?? "" }
      if .stack == "" { .stack = "homelab-home-prod-mon" }

      .service = to_string(.label."com.docker.compose.service") ?? ""
      if .service == "" { .service = to_string(.labels."com.docker.compose.service") ?? "" }
      if .service == "" { .service = to_string(.docker.container.labels."com.docker.compose.service") ?? "" }
      if .service == "" { .service = .container_name }

      # namespace: fixed
      .namespace = to_string(.namespace) ?? "prod"

      # Level normalization (avoid else-if chains)
      tmp = downcase(to_string(.level) ?? "")
      if tmp != "" {
        .level = tmp
      } else {
        m = downcase(.message)
        if contains(m, "error") { .level = "error" }
        else {
          if contains(m, "warn") { .level = "warn" }
          else {
            if contains(m, "debug") { .level = "debug" }
            else { .level = "info" }
          }
        }
      }

      # Drop ballast to keep payload small
      del(.label)
      del(.labels)
      del(.docker)
      del(.container)
      del(.image)

sinks:
  vlogs:
    type: http
    inputs: ["normalize"]
    uri: >-
      http://victorialogs:9428/insert/jsonline
      ?_stream_fields=host,stack,service,namespace,container_name
      &_msg_field=message
      &_time_field=timestamp
    compression: gzip
    encoding:
      codec: json
    framing:
      method: newline_delimited
    healthcheck:
      enabled: true
    buffer:
      type: memory
      # REQUIRED in many Vector buffer configs; otherwise BufferConfig won't match.
      # 64 MiB:
      max_size: 67108864
      max_events: 10000
      when_full: drop_newest
