api:
  enabled: true
  address: 127.0.0.1:8686
  playground: false

sources:
  docker:
    type: docker_logs
    docker_host: unix:///var/run/docker.sock

transforms:
  normalize:
    type: remap
    inputs: ["docker"]
    source: |
      # 1) Message
      .message = to_string(.message) ?? to_string(.log) ?? ""

      # 2) Timestamp (best-effort)
      .timestamp = parse_timestamp(.timestamp, "%+") ?? now()

      # 3) Low-cardinality stream fields
      .host = get_env_var("HOSTNAME") ?? "unknown-pi"

      .container_name = to_string(.container_name) ?? ""
      if .container_name == "" { .container_name = to_string(.container) ?? "" }
      if .container_name == "" { .container_name = to_string(.docker.container_name) ?? "" }
      if .container_name == "" { .container_name = "unknown" }

      # IMPORTANT: in deinem Setup kommen Compose-Labels als flache Felder mit Punkten im Key:
      #   label.com.docker.compose.project
      #   label.com.docker.compose.service
      .stack = to_string(."label.com.docker.compose.project") ?? "homelab-home-prod-mon"
      .service = to_string(."label.com.docker.compose.service") ?? .container_name
      .namespace = to_string(.namespace) ?? "prod"

      # 4) Level normalization (VRL 0.51: kein else-if; robust verschachteln)
      lvl = downcase(to_string(.level) ?? "")
      if lvl == "" {
        msg = downcase(.message)
        if contains(msg, "error") { lvl = "error" }
        else {
          if contains(msg, "warn") { lvl = "warn" }
          else {
            if contains(msg, "debug") { lvl = "debug" }
            else { lvl = "info" }
          }
        }
      }
      .level = lvl

      # 5) Ballast abwerfen: exakt das Ziel-Event bauen (verhindert Label-/Metadata-Flut)
      . = {
        "timestamp": .timestamp,
        "message": .message,
        "level": .level,
        "host": .host,
        "stack": .stack,
        "service": .service,
        "namespace": .namespace,
        "container_name": .container_name
      }

sinks:
  vlogs:
    type: http
    inputs: ["normalize"]
    uri: >-
      http://victorialogs:9428/insert/jsonline
      ?_stream_fields=host,stack,service,namespace,container_name
      &_msg_field=message
      &_time_field=timestamp
    compression: gzip
    encoding:
      codec: json
    framing:
      method: newline_delimited
    healthcheck:
      enabled: true
    buffer:
      type: memory
      max_events: 10000
      max_size: 67108864 # 64 MiB hard cap (Pi-safe)
      when_full: drop_newest
