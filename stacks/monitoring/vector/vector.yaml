api:
  enabled: true
  address: 127.0.0.1:8686
  playground: false

sources:
  docker:
    type: docker_logs
    docker_host: unix:///var/run/docker.sock
  host_journald:
    type: journald

transforms:
  # Filter journald down to just the desired systemd units.
  filter_journald_units:
    type: remap
    inputs: ["host_journald"]
    source: |
      allowed = [
        "docker.service",
        "containerd.service",
        "ufw.service",
        "sshd.service",
        "systemd-udevd.service",
      ]

      # Keep only entries that have a systemd unit and are in the allowed list.
      # (Most unit-scoped messages have _SYSTEMD_UNIT set.)
      if !exists(._SYSTEMD_UNIT) {
        abort
      }

      unit = to_string(._SYSTEMD_UNIT) ?? ""
      if unit == "" || !includes(allowed, unit) {
        abort
      }

  normalize:
    type: remap
    inputs: ["docker", "filter_journald_units"]
    # yamllint disable rule:line-length
    source: |
      # 1. Message & Timestamp
      # Message field for VictoriaLogs (_msg_field=message)
      .message = to_string(.message) ?? to_string(.log) ?? to_string(.MESSAGE) ?? ""
      # Timestamp field for VictoriaLogs (_time_field=timestamp)
      # - docker_logs usually provides .timestamp
      # - journald provides _SOURCE_REALTIME_TIMESTAMP (microseconds since epoch) and/or __REALTIME_TIMESTAMP
      .timestamp = to_timestamp(.timestamp) ?? to_timestamp(._SOURCE_REALTIME_TIMESTAMP) ?? parse_timestamp(to_string(.timestamp) ?? "", "%+") ?? now()

      # 2. Host & Container
      # Host (prefer env injection; fallback to container hostname)
      .host = get_env_var("HOST_NODE_NAME") ?? get_env_var("HOSTNAME") ?? "unknown-pi" ?? "unknown"
      # Container / identity
      # - docker_logs: .container_name, labels
      # - journald: _SYSTEMD_UNIT / SYSLOG_IDENTIFIER
      .container_name = to_string(.container_name) ?? to_string(.docker.container_name) ?? to_string(._SYSTEMD_UNIT) ?? to_string(.SYSLOG_IDENTIFIER) ?? "unknown"

      # 3. Stack & Service Labels: Compose metadata if present (docker); otherwise derive from unit
      .stack = to_string(.label."com.docker.compose.project") ?? to_string(.labels."com.docker.compose.project") ?? "homelab-home-prod"
      .service = to_string(.label."com.docker.compose.service") ?? to_string(.labels."com.docker.compose.service") ?? .container_name

      # Fix for E651: Einfache Zuweisung, da .namespace vorher nicht existiert
      .namespace = "prod"

      # 4. Basic level normalization (flat & safe)
      tmp = downcase(to_string(.level) ?? "")
      if tmp != "" {
        .level = tmp
      } else {
        .level = "info"
        m = downcase(.message)
        if contains(m, "debug") { .level = "debug" }
        if contains(m, "warn")  { .level = "warn" }
        if contains(m, "error") { .level = "error" }
      }

      # 5. Keep original unit (useful for queries), if present
      if exists(._SYSTEMD_UNIT) {
        .systemd_unit = to_string(._SYSTEMD_UNIT) ?? null
      }

      # 6. Cleanup: Reduce noise / remove bulky nested structures commonly present on docker events
      del(.label)
      del(.labels)
      del(.docker)
      del(.container)
      del(.image)
      del(.container_id)
      del(.container_created_at)
      del(.source_type)
      del(.stream) # stderr/stdout ist oft redundant, wenn level gesetzt ist

sinks:
  vlogs:
    type: http
    inputs: ["normalize"]
    # yamllint disable-line rule:line-length
    uri: "http://victorialogs:9428/insert/jsonline?_stream_fields=host,stack,service,namespace,container_name&_msg_field=message&_time_field=timestamp"
    compression: gzip
    encoding:
      codec: json
    framing:
      method: newline_delimited
    healthcheck:
      enabled: true
    buffer:
      type: memory
      max_events: 10000
      when_full: drop_newest
